<!DOCTYPE html>
<html>
<head>
	<title>ecsmas 2011</title>
</head>
<style>
* { margin:0; padding:0; border:0; }
html, body { background:#eee; overflow:hidden; }
canvas { position:absolute; top:0; left:0; }

@-webkit-keyframes makeitso {
	from { opacity:0; }
	to {opacity:.4; }
}
@-moz-keyframes makeitso {
	from {opacity:0;}
	to {opacity:.4;}
}
.snow { opacity:0; }
.fadein {
	-webkit-animation: makeitso 2s 0s 2 ease-in-out alternate;
	-moz-animation: makeitso 2s 0s 2 ease-in-out alternate;
}

textarea { display:none;
	position:absolute; top:65%; left:35%; width:30%; height:25%; border:2px solid gray;
	padding:4px; font-size:16px; font-family:'Comic Sans MS', cursive; resize:none;
}
</style>
<body>
	<canvas id="background"></canvas>
	<canvas id="foreground"></canvas>
	<canvas id="trees"></canvas>
	<canvas id="ltree"></canvas>
	<textarea></textarea>
</body>
<script>
	PHI = Math.sqrt(5)/2+.5;
	TWOPI = Math.PI*2;
</script>
<script src="js/gift.js"></script>
<script src="js/phlaky.js"></script>
<script>
(function() {
	var main = this;

	// callback handler for triggering events at specific times
	var Callbacks = (function() {
		var map = {};
		return {
			addEventListener: function(event,callback) {
				map[event] = map[event] || [];
				map[event].push(callback);
			},
			trigger: function(event) {
				if (typeof map[event] === 'undefined') 
					return;
				for (var i in map[event])
					map[event][i].call(main);
			}
		};
	})();

	// bind to resize event
	(function() {
		var canvi = document.getElementsByTagName('canvas'), i, timeout;
		function update_canvi() {
			for (i in canvi) {
				canvi[i].width = window.innerWidth;
				canvi[i].height = window.innerHeight;
			}
			Callbacks.trigger('resize');
		}
		update_canvi();
		window.addEventListener('resize',function() {
			// use delay to prevent retriggering updates on every single resize event
			clearTimeout(timeout);
			timeout = setTimeout(update_canvi,200);	
		});
	})();

	// set up animation request frame
	var requestAnimationFrame = (function() {
		return window.requestAnimationFrame || 
            window.webkitRequestAnimationFrame || 
			window.mozRequestAnimationFrame ||  
            window.msRequestAnimationFrame ||
            function (callback) {
            	window.setTimeout(callback,30);
            }
	})();

	Number.prototype.degreesToRadians = function() { return this*Math.PI/180; };

    Callbacks.addEventListener('resize',render_page);
    Callbacks.trigger('resize');

    function render_page() {
	    // snow canvas shenanigance
	    (function() { 

	    	var fg_canvas = document.getElementById('foreground');

	    	function new_flake(canvas) {
				if (typeof canvas === 'number') {
					var i = canvas,
						canvas = document.createElement('canvas');
					canvas.id = 'flake'+i;
					canvas['data-flake-id'] = i;
					canvas.width = canvas.height = 60;
					document.body.insertBefore(canvas,fg_canvas);
				}

	    		canvas.style.opacity = 0;
				canvas.className = 'flake';
				var ctx = canvas.getContext('2d'),
					i = i || canvas['data-flake-id'];

				canvas.style.top = ((window.innerHeight*Math.random())|0)+'px';
				canvas.style.left = ((window.innerWidth*Math.random())|0)+'px';

				ctx.clearRect(0,0,60,60); 
				new_flake.x = new_flake.x || 0;
				if (new_flake.x ^= 1) {
					snowflake(i, 30,30, ctx);	
				}
				else {
					phlake(i, 30,30, ctx);	
				} 
				return canvas;
	    	}

	    	function kill_a_flake(node) {
	    		node.className = '';
	    		var dead_to_me = node.parentNode && node.parentNode.removeChild(node);
	    		dead_to_me = null;
	    	}

	    	function add_a_flake(canvas) {
	    		var flake = new_flake(canvas);
	    		// force reflow with 0 timeout
	    		setTimeout(function() {
	    			flake.className = 'flake fadein';
	    		},0);
	    		// if (i % 15 === 0) 
	    		// 	flake.className += '';
	    	}

	    	function flake_is_over(e) {
				if (/flake fadein/.test(e.target.className) === false) return;
				add_a_flake(e.target);
			}

			document.body.addEventListener('webkitAnimationEnd',flake_is_over,false);
			document.body.addEventListener('animationend',flake_is_over,false);
			
			(function() {
				var flakes = Math.max(20,(window.innerWidth*window.innerHeight)/18000|0);
				console.log(flakes);

				// kill any existing
				var dead_flakes = [].slice.call(document.getElementsByClassName('flake')), i;
				for (i in dead_flakes)
					kill_a_flake(dead_flakes[i]);

				(function() {
					add_a_flake(flakes--);
					if (flakes) 
						setTimeout(arguments.callee, 200*Math.random()|0);
				})();

			})();

		})();


		// winter wonderland canvas shenanigantz
		(function() {
			var bg_canvas = document.getElementById('background'),
				bg_ctx = bg_canvas.getContext('2d'),
				fg_canvas = document.getElementById('foreground'),
				fg_ctx = fg_canvas.getContext('2d');

			
			var w = bg_canvas.width,
				h = bg_canvas.height,
				bgc = bg_ctx,
				fgc = fg_ctx;


			// bg hill
			bgc.save();
			bgc.beginPath();
			bgc.fillStyle = 'rgb(220,230,240)';
			bgc.moveTo(0,h/6);
			bgc.bezierCurveTo(w/4,h/10,w/2,h/6,w,h/12);
			bgc.lineTo(w,h);
			bgc.lineTo(0,h);
			bgc.fill();
			bgc.restore();

			// main hill
			fgc.save();
			fgc.beginPath();
			fgc.strokeStyle = 'rgb(200,210,230)';
			fgc.fillStyle = 'rgb(230,230,230)';
			fgc.lineWidth = 3;
			fgc.moveTo(0,h);
			fgc.bezierCurveTo(w/3,h/3,w/2,h/2,w,h/1.5);
			fgc.stroke();
			fgc.lineTo(w,h);
			fgc.lineTo(0,h);
			fgc.fill();
			fgc.restore();


		})();

    }
	
})();	
</script>
</html>